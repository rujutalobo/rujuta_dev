name: Thank Contributors on Merge

env:
  ACTIONS_STEP_DEBUG: ${{ secrets.ACTIONS_STEP_DEBUG }}
  ACTIONS_RUNNER_DEBUG: ${{ secrets.ACTIONS_RUNNER_DEBUG }}

on:
  pull_request_target:
    types: [closed]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  thank-you:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Debug context
        run: |
          echo "Author Association: ${{ github.event.pull_request.author_association }}"
          echo "User: ${{ github.event.pull_request.user.login }}"
          echo "Merged: ${{ github.event.pull_request.merged }}"

      - name: Send thank-you message based on contribution level
        uses: actions/github-script@v7
        with:
          script: |
            const login = context.payload.pull_request.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'master'; 

            // Fetch *all merged PRs* by this user in this repo
            const { data: allPRs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "closed",
              per_page: 100
            });

            // Count how many merged PRs they have
            const mergedCount = allPRs.filter(pr => pr.user.login === login && pr.merged_at).length;

            console.log(`Merged PR count for ${login}: ${mergedCount}`);

            // Pick the correct sticker and message
            let imageUrl = ``;
            let messageHeader = ``          

            if (mergedCount == 10) {
              imageUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/images/cooking.png`;
              messageHeader = `🏆 Amazing work @${login}! You've hit **50 merged PRs** — you're a project champion! 🏆`;
            } else if (mergedCount == 8) {
              imageUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/images/chemistry.png`;
              messageHeader = `🌟 Incredible @${login}! **25 merged PRs** — your consistent contributions are powering this project!`;
            } else if (mergedCount == 5) {
              imageUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/images/halloween.png`;
              messageHeader = `🚀 Awesome @${login}! You've reached **10 merged PRs** — we truly appreciate your dedication!`;
            } else if (mergedCount == 1) {
              imageUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/images/1stpr.png`;
              messageHeader = `🎉 Huge thanks @${login} for your **first contribution**!! 🎉`;
            }

                  // Check that both exist and are non-empty
            if (messageHeader && imageUrl) {
               const message = `
              ${messageHeader}
              @${login}, we appreciate your contribution! 🚀

              ![Sticker](${imageUrl})
               `;

              await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner,
              repo,
              body: message
             });
             } else {
              console.log("No messageHeader or imageUrl found — skipping comment.");
            }
